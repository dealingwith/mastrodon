---
import MastodonPost from '../components/MastodonPost.astro';
import type { MastodonPost as MastodonPostType } from '../types/mastodon';

// Load Mastodon archive from JSON file
let posts: MastodonPostType[] = [];

try {
  // Import the JSON file directly
  const archiveData = await import('../../public/mastodon-archive.json');
  const data = archiveData.default;
  
  // Handle ActivityPub format
  if (data.orderedItems) {
    posts = data.orderedItems
      .filter((item: any) => item.type === 'Create' && item.object && item.object.type === 'Note')
      .map((item: any) => {
        const obj = item.object;
        return {
          id: obj.id || Math.random().toString(),
          created_at: obj.published || new Date().toISOString(),
          content: obj.content || '',
          url: obj.url || obj.id,
          visibility: 'public',
          sensitive: obj.sensitive || false,
          spoiler_text: obj.summary || '',
          media_attachments: obj.attachment?.map((att: any) => ({
            id: att.id || Math.random().toString(),
            type: att.mediaType?.includes('image') ? 'image' : 
                  att.mediaType?.includes('video') ? 'video' : 
                  att.mediaType?.includes('audio') ? 'audio' : 'unknown',
            url: att.url || att.href,
            preview_url: att.url || att.href,
            description: att.name || att.summary
          })) || [],
          account: {
            id: obj.attributedTo || 'unknown',
            username: obj.attributedTo?.split('/').pop() || 'user',
            display_name: obj.attributedTo?.split('/').pop() || 'User',
            avatar: '/favicon.svg',
            url: obj.attributedTo || ''
          },
          replies_count: obj.replies?.totalItems || 0,
          reblogs_count: obj.shares?.totalItems || 0,
          favourites_count: obj.likes?.totalItems || 0
        };
      });
  }
  
  // Sort by date (newest first)
  posts.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());
} catch (error) {
  console.log('Could not load mastodon-archive.json:', error);
}
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>Mastodon Archive</title>
		<style>
			@import "tailwindcss";
		</style>
	</head>
	<body class="bg-gray-100 text-gray-900 font-sans">
		<header class="bg-indigo-600 text-white">
			<div class="max-w-4xl mx-auto px-4 py-8 text-center">
				<h1 class="text-4xl font-bold mb-2">My Mastodon Archive</h1>
				<p class="text-indigo-200 text-lg">A static archive of my Mastodon posts</p>
			</div>
		</header>

		<main class="max-w-4xl mx-auto px-4 py-8">
			{posts.length === 0 && (
				<div class="bg-white rounded-lg shadow-md p-8 text-center border border-gray-200">
					<h2 class="text-2xl font-semibold text-gray-600 mb-4">No posts found</h2>
					<p class="text-gray-600 mb-4">Place your Mastodon archive JSON file at <code class="bg-gray-100 px-2 py-1 rounded text-sm font-mono">public/mastodon-archive.json</code> to see your posts here.</p>
					<div class="text-left max-w-md mx-auto">
						<p class="font-semibold mb-2">To use this app:</p>
						<ol class="list-decimal list-inside space-y-1 text-gray-700">
							<li>Export your Mastodon archive from your instance</li>
							<li>Extract the archive and locate the JSON file (usually named like 'outbox.json')</li>
							<li>Place it in the public folder as 'mastodon-archive.json'</li>
							<li>Restart the development server</li>
						</ol>
					</div>
				</div>
			)}

			<div class="space-y-6">
				{posts.map((post) => (
					<MastodonPost post={post} />
				))}
			</div>
		</main>
	</body>
</html>

